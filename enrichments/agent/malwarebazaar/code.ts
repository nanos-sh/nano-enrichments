// MalwareBazaar Agent Enrichment â€” Malware sample lookup
// Docs: https://bazaar.abuse.ch/api/

interface AgentEnrichmentResult {
  key: string;
  key_type: "ip" | "domain" | "hash" | "url";
  risk_score?: number;
  tags?: string[];
  data: Record<string, unknown>;
}

async function enrich(
  artifact: string,
  artifactType: string,
  credentials: Record<string, string>,
): Promise<AgentEnrichmentResult> {
  const res = await fetch("https://mb-api.abuse.ch/api/v1/", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `query=get_info&hash=${encodeURIComponent(artifact)}`,
  });
  if (!res.ok) throw new Error(`MalwareBazaar API error: ${res.status}`);
  const data = await res.json();

  if (
    data.query_status === "hash_not_found" ||
    data.query_status === "no_results"
  ) {
    return { key: artifact, key_type: "hash", data: { found: false } };
  }

  const sample = data.data?.[0];
  if (!sample) {
    return { key: artifact, key_type: "hash", data: { found: false } };
  }

  const tags: string[] = sample.tags ?? [];
  if (sample.signature) tags.push(sample.signature);
  if (sample.intelligence?.clamav) tags.push("clamav-detected");

  return {
    key: artifact,
    key_type: "hash",
    risk_score: 90,
    tags,
    data: {
      sha256: sample.sha256_hash,
      sha1: sample.sha1_hash,
      md5: sample.md5_hash,
      file_type: sample.file_type,
      file_type_mime: sample.file_type_mime,
      file_size: sample.file_size,
      signature: sample.signature,
      reporter: sample.reporter,
      first_seen: sample.first_seen,
      last_seen: sample.last_seen,
      delivery_method: sample.delivery_method,
      intelligence: sample.intelligence,
    },
  };
}

export { enrich };
